<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizMatrix - Thách Thức Trí Tuệ Số</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-image: linear-gradient(135deg, #e0f7fa 0%, #e8eaf6 100%); /* New light gradient background */
            color: #1a202c; /* Dark text */
            scroll-behavior: smooth;
        }
        
        #main-screen, #review-screen, #result-screen, #auth-screen, #quiz-screen {
             background-image: url('https://www.transparenttextures.com/patterns/subtle-prism.png'), linear-gradient(135deg, #e0f7fa 0%, #e8eaf6 100%);
            background-attachment: fixed;
        }

        .glow-text {
            font-family: 'Montserrat', sans-serif;
            color: #2c5282; /* Dark blue */
            text-shadow: 0 0 8px rgba(44, 82, 130, 0.3);
        }

        .card-tech {
            background: rgba(255, 255, 255, 0.7); /* Light semi-transparent card */
            border: 1px solid #e2e8f0; /* Slate border */
            backdrop-filter: blur(10px);
            transition: all 0.3s ease-in-out;
        }

        .card-tech:hover:not(.no-hover) {
            transform: translateY(-5px) scale(1.02);
            border-color: #2c5282;
            box-shadow: 0 4px 25px rgba(44, 82, 130, 0.15);
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e2e8f0; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #2c5282; }
        
        /* Animation */
        .fade-in { animation: fadeInAnimation 0.5s ease-in-out; }
        @keyframes fadeInAnimation {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Chatbot styles */
        #chatbot-container.open {
            opacity: 1;
            transform: translateY(0);
        }
        .user-message {
            background-color: #dbeafe;
            color: #1e3a8a;
        }
        .bot-message {
            background-color: #f1f5f9;
            color: #334155;
        }
    </style>
</head>

<body>

    <!-- Container chính của ứng dụng -->
    <div id="app-container" class="min-h-screen">

        <!-- Màn hình tải -->
        <div id="loading-screen" class="fixed inset-0 bg-[#e0f7fa] z-50 flex items-center justify-center">
            <div class="flex flex-col items-center">
                 <svg class="h-16 w-16 text-[#2c5282] animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg font-semibold text-gray-600">Đang khởi tạo hệ thống...</p>
            </div>
        </div>

        <!-- Màn hình Đăng nhập / Đăng ký -->
        <div id="auth-screen" class="hidden min-h-screen flex items-center justify-center p-4 fade-in">
            <div class="w-full max-w-md">
                <div class="card-tech rounded-2xl shadow-xl p-8 no-hover">
                    <div class="flex items-center justify-center mb-6">
                        <!-- THAY ĐỔI LOGO: Thay đổi src="..." bằng đường dẫn đến logo của bạn -->
                        <img src="https://placehold.co/200x50/e0f7fa/2c5282?text=LogoCuaBan" alt="Logo Công ty" class="h-12">
                    </div>

                    <!-- Tabs -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="flex -mb-px space-x-6">
                            <button id="login-tab-btn" class="py-4 px-1 border-b-2 font-medium text-lg border-[#2c5282] text-[#2c5282]">Đăng Nhập</button>
                            <button id="register-tab-btn" class="py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Đăng Ký</button>
                        </nav>
                    </div>

                    <!-- Form -->
                    <form id="login-form" class="space-y-6">
                        <div>
                            <label for="login-email" class="text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="login-email" required class="mt-1 w-full px-4 py-3 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-[#2c5282] focus:border-[#2c5282] transition">
                        </div>
                        <div>
                            <label for="login-password" class="text-sm font-medium text-gray-700">Mật khẩu</label>
                            <input type="password" id="login-password" required class="mt-1 w-full px-4 py-3 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-[#2c5282] focus:border-[#2c5282] transition">
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white focus:ring-green-600 transition-transform transform hover:scale-105">Đăng Nhập</button>
                    </form>
                    <form id="register-form" class="hidden space-y-6">
                        <div>
                            <label for="register-email" class="text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="register-email" required class="mt-1 w-full px-4 py-3 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-[#2c5282] focus:border-[#2c5282] transition">
                        </div>
                        <div>
                            <label for="register-password" class="text-sm font-medium text-gray-700">Mật khẩu</label>
                            <input type="password" id="register-password" required class="mt-1 w-full px-4 py-3 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-[#2c5282] focus:border-[#2c5282] transition">
                        </div>
                        <button type="submit" class="w-full bg-blue-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white focus:ring-blue-700 transition-transform transform hover:scale-105">Đăng Ký</button>
                    </form>
                    <p id="auth-error" class="mt-4 text-center text-red-600 font-medium"></p>
                </div>
            </div>
        </div>

        <!-- Màn hình chính (sau khi đăng nhập) -->
        <div id="main-screen" class="hidden fade-in">
            <!-- Header -->
            <header class="bg-white/80 backdrop-blur-md shadow-lg sticky top-0 z-40 border-b border-gray-200">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-20">
                        <div class="flex items-center">
                           <!-- THAY ĐỔI LOGO: Thay đổi src="..." bằng đường dẫn đến logo của bạn -->
                           <img src="https://placehold.co/150x40/e0f7fa/2c5282?text=LogoCuaBan" alt="Logo Công ty" class="h-10">
                        </div>
                        <div class="flex items-center space-x-4">
                            <span id="user-email" class="text-md font-medium text-gray-700 hidden sm:block"></span>
                            <button id="logout-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-transform transform hover:scale-105">Đăng Xuất</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Lựa chọn bài thi -->
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
                <div class="text-center mb-12">
                    <h2 class="text-4xl md:text-5xl font-extrabold glow-text tracking-tight">CHỌN BÀI KIỂM TRA</h2>
                    <p class="mt-4 text-lg text-gray-600">Hãy chọn một thử thách để bắt đầu hành trình chinh phục kiến thức của bạn.</p>
                </div>

                <div id="quiz-selection-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Các thẻ bài thi sẽ được render vào đây bằng JS -->
                </div>
            </div>


            <!-- Khu vực hiển thị kết quả cũ -->
             <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-3xl font-bold glow-text">Lịch sử làm bài</h3>
                    <button id="delete-history-btn" class="hidden bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-500 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">Xóa Tất Cả</button>
                </div>
                <div id="past-results-container" class="card-tech p-6 rounded-2xl shadow-lg no-hover">
                    <p id="no-results-text" class="text-gray-500">Chưa có dữ liệu nào được ghi nhận.</p>
                    <div id="results-list" class="space-y-4"></div>
                </div>
            </div>
        </div>
        
        <!-- Màn hình làm bài trắc nghiệm -->
        <div id="quiz-screen" class="hidden fade-in">
             <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div id="questions-container" class="lg:col-span-8 card-tech p-6 rounded-2xl shadow-lg h-[85vh] overflow-y-auto custom-scrollbar no-hover"></div>
                    <div class="lg:col-span-4">
                        <div class="sticky top-8 space-y-6">
                            <div class="card-tech p-6 rounded-2xl shadow-lg no-hover">
                                <h3 class="text-xl font-bold mb-4 glow-text">Bảng điều khiển</h3>
                                <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg border border-gray-200">
                                    <span class="font-semibold text-gray-700">Thời gian:</span>
                                    <span id="timer" class="text-2xl font-bold text-red-500 font-mono">10:00</span>
                                </div>
                                <button id="submit-quiz-btn" class="mt-6 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-transform transform hover:scale-105">Nộp Bài</button>
                            </div>
                            <div class="card-tech p-6 rounded-2xl shadow-lg no-hover">
                                <h3 class="text-xl font-bold mb-4 glow-text">Điều hướng</h3>
                                <div id="question-nav" class="grid grid-cols-5 sm:grid-cols-8 lg:grid-cols-5 gap-2"></div>
                                <div class="mt-4 space-y-2 text-sm text-gray-500">
                                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-white border-2 border-gray-300 mr-2"></span>Chưa trả lời</div>
                                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-500 mr-2"></span>Đã trả lời</div>
                                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-yellow-400 mr-2"></span>Đã đánh dấu</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Màn hình kết quả -->
        <div id="result-screen" class="hidden min-h-screen flex items-center justify-center p-4 fade-in">
            <div class="card-tech rounded-2xl shadow-xl p-8 text-center max-w-4xl w-full no-hover">
                <h2 class="text-4xl font-extrabold glow-text">HOÀN THÀNH</h2>
                <p class="mt-2 text-lg text-gray-600">Kết quả của bạn đã được ghi nhận vào hệ thống.</p>
                <div class="my-8">
                    <div class="relative inline-flex items-center justify-center w-48 h-48">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="text-gray-200" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                            <circle id="progress-circle" class="text-[#2c5282]" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" style="transition: stroke-dashoffset 0.5s ease-in-out; transform: rotate(-90deg); transform-origin: 50% 50%;" />
                        </svg>
                        <span id="score-text" class="absolute text-4xl font-bold text-gray-800">0/0</span>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-lg">
                     <div class="bg-green-100 p-4 rounded-lg border border-green-200">
                        <p class="font-bold text-green-800">Đúng</p>
                        <p id="correct-answers" class="text-2xl font-bold text-green-800">0</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg border border-red-200">
                        <p class="font-bold text-red-800">Sai</p>
                        <p id="incorrect-answers" class="text-2xl font-bold text-red-800">0</p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg border border-gray-200">
                        <p class="font-bold text-gray-800">Bỏ qua</p>
                        <p id="unanswered-questions" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                </div>

                <!-- Chi tiết bài làm -->
                <div class="mt-8 w-full text-left">
                    <h3 class="text-2xl font-bold glow-text mb-4 text-center">Chi tiết bài làm</h3>
                    <div id="result-details-container" class="max-h-[40vh] overflow-y-auto custom-scrollbar space-y-4 pr-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <!-- Details will be rendered here -->
                    </div>
                </div>
                
                <div class="mt-8">
                    <button id="back-to-home-btn" class="bg-blue-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-800 transition-transform transform hover:scale-105">Trở về Trang chủ</button>
                </div>
            </div>
        </div>
        
        <!-- Màn hình xem lại bài làm -->
        <div id="review-screen" class="hidden fade-in min-h-screen">
            <header class="bg-white/80 backdrop-blur-md shadow-lg sticky top-0 z-40 border-b border-gray-200">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-20">
                        <div class="flex items-center">
                           <!-- THAY ĐỔI LOGO: Thay đổi src="..." bằng đường dẫn đến logo của bạn -->
                           <img src="https://placehold.co/150x40/e0f7fa/2c5282?text=LogoCuaBan" alt="Logo Công ty" class="h-10">
                            <h1 id="review-title" class="ml-3 text-2xl font-bold glow-text">Xem Lại Bài Làm</h1>
                        </div>
                        <button id="back-from-review-btn" class="bg-blue-700 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-800 transition-transform transform hover:scale-105">Quay Lại</button>
                    </div>
                </div>
            </header>
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div id="review-content-container" class="card-tech p-6 rounded-2xl shadow-lg no-hover">
                    <div id="review-content" class="space-y-8">
                        <!-- Nội dung xem lại sẽ được render vào đây -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Chatbot Floating Button -->
    <button id="chatbot-toggle-btn" class="hidden fixed bottom-6 right-6 bg-blue-700 text-white rounded-full p-4 shadow-lg hover:bg-blue-800 transition-transform transform hover:scale-110 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9.43 13.57c-.23-.23-.3-.59-.16-.88.22-.45.5-.85.82-1.22.2-.23.55-.26.8-.06.25.2.28.55.06.8-.29.33-.54.7-.72 1.12-.13.31-.47.45-.7.24zm5.14 0c-.23-.23-.3-.59-.16-.88.22-.45.5-.85.82-1.22.2-.23.55-.26.8-.06.25.2.28.55.06.8-.29.33-.54.7-.72 1.12-.13.31-.47.45-.7.24z"/>
        </svg>
    </button>

    <!-- Chatbot Window -->
    <div id="chatbot-container" class="hidden fixed bottom-24 right-6 w-full max-w-sm h-[70vh] bg-white rounded-2xl shadow-2xl flex-flex-col z-50 transition-all duration-300 transform translate-y-4 opacity-0">
        <!-- Header -->
        <div class="flex justify-between items-center p-4 bg-blue-700 text-white rounded-t-2xl">
            <h3 class="font-bold text-lg">DeepSeek Assistant</h3>
            <button id="chatbot-close-btn" class="text-white text-2xl font-bold hover:text-gray-200">&times;</button>
        </div>
        <!-- Messages -->
        <div id="chatbot-messages" class="flex-1 p-4 overflow-y-auto custom-scrollbar">
            <div class="bot-message p-3 rounded-lg mb-2 max-w-xs break-words">
                Xin chào! Tôi có thể giúp gì cho bạn?
            </div>
        </div>
        <!-- Input -->
        <form id="chatbot-form" class="p-4 border-t border-gray-200">
            <div class="flex">
                <input type="text" id="chatbot-input" placeholder="Hỏi điều gì đó..." class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-600" autocomplete="off">
                <button type="submit" id="chatbot-send-btn" class="bg-blue-700 text-white px-4 rounded-r-lg hover:bg-blue-800 disabled:bg-blue-400">Gửi</button>
            </div>
        </form>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, doc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
       const firebaseConfig = typeof __firebase_config !== 'undefined' 
    ? JSON.parse(__firebase_config)
    : {
        apiKey: "AIzaSyCE9pYi-F8f8aJ66GvhlgrXVnTdJBz4sNc",
        authDomain: "jtscdb.firebaseapp.com",
        projectId: "jtscdb",
        storageBucket: "jtscdb.firebasestorage.app",
        messagingSenderId: "Y676905178628",
        appId: "1:676905178628:web:5242a9e2cfedf0b7640751"
    };

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

        // --- CÁC BỘ CÂU HỎI ---
        const allQuizzes = {
            web_dev: {
                title: "Kiến thức Lập trình Web",
                description: "Kiểm tra các khái niệm cơ bản về HTML, CSS, và JavaScript.",
                questions: [
                    { question: "HTML là viết tắt của cụm từ nào?", options: ["Hyper Text Markup Language", "High Tech Modern Language", "Hyperlink and Text Markup Language", "Home Tool Markup Language"], correctAnswer: 0 },
                    { question: "Thuộc tính CSS nào dùng để thay đổi màu nền của một phần tử?", options: ["color", "font-size", "background-color", "text-align"], correctAnswer: 2 },
                ]
            },
            space: {
                title: "Khoa học Vũ trụ",
                description: "Khám phá kiến thức về các hành tinh, ngôi sao và thiên hà.",
                questions: [
                    { question: "Hành tinh nào được mệnh danh là 'Hành tinh Đỏ'?", options: ["Sao Kim", "Sao Hỏa", "Sao Mộc", "Sao Thổ"], correctAnswer: 1 },
                ]
            },
            history_vn: {
                title: "Lịch sử Việt Nam",
                description: "Tìm hiểu về các sự kiện và nhân vật lịch sử quan trọng của Việt Nam.",
                questions: [
                    { question: "Chiến thắng Điện Biên Phủ diễn ra vào năm nào?", options: ["1945", "1954", "1968", "1975"], correctAnswer: 1 },
                ]
            },
            geography: {
                title: "Địa lý Thế giới",
                description: "Thử thách hiểu biết của bạn về các quốc gia, châu lục và đại dương.",
                 questions: [
                    { question: "Dòng sông nào dài nhất thế giới?", options: ["Sông Nile", "Sông Amazon", "Sông Mississippi", "Sông Dương Tử"], correctAnswer: 0 },
                ]
            },
            literature: {
                title: "Văn học Hiện đại",
                description: "Kiểm tra kiến thức về các tác giả, tác phẩm nổi tiếng trong văn học.",
                questions: [
                    { question: "Ai là tác giả của tác phẩm 'Số Đỏ'?", options: ["Nam Cao", "Ngô Tất Tố", "Vũ Trọng Phụng", "Nguyễn Công Hoan"], correctAnswer: 2 },
                ]
            }
        };

        // --- BIẾN TRẠNG THÁI ---
        let userAnswers = {};
        let timerInterval;
        let currentQuizId = null;
        let currentQuestions = [];

        // --- DOM ELEMENTS ---
        const screens = {
            loading: document.getElementById('loading-screen'),
            auth: document.getElementById('auth-screen'),
            main: document.getElementById('main-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen'),
            review: document.getElementById('review-screen')
        };
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error');
        const loginTabBtn = document.getElementById('login-tab-btn');
        const registerTabBtn = document.getElementById('register-tab-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        const submitQuizBtn = document.getElementById('submit-quiz-btn');
        const quizSelectionContainer = document.getElementById('quiz-selection-container');
        const resultsListContainer = document.getElementById('results-list');
        const backFromReviewBtn = document.getElementById('back-from-review-btn');
        const deleteHistoryBtn = document.getElementById('delete-history-btn');
        
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            if (screens[screenName]) screens[screenName].classList.remove('hidden');
        }
        
        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            screens.loading.classList.add('hidden');
            const chatbotToggleBtn = document.getElementById('chatbot-toggle-btn');
            if (user) {
                document.getElementById('user-email').textContent = user.email;
                renderQuizSelection();
                await loadPastResults(user.uid);
                showScreen('main');
                chatbotToggleBtn.classList.remove('hidden');
            } else {
                showScreen('auth');
                chatbotToggleBtn.classList.add('hidden');
            }
        });
        
        // --- QUIZ LOGIC (No changes here, keeping it for context) ---
        function renderQuizSelection() {
            quizSelectionContainer.innerHTML = '';
            for (const quizId in allQuizzes) {
                const quiz = allQuizzes[quizId];
                const card = document.createElement('div');
                card.className = 'card-tech rounded-lg p-6 flex flex-col items-center text-center cursor-pointer';
                card.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${quiz.title}</h3>
                    <p class="text-gray-600 mb-4 flex-grow">${quiz.description}</p>
                    <button data-quiz-id="${quizId}" class="start-quiz-btn w-full bg-blue-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-800 transition">Bắt đầu</button>
                `;
                quizSelectionContainer.appendChild(card);
            }
        }
        quizSelectionContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('start-quiz-btn')) {
                const quizId = e.target.dataset.quizId;
                startQuiz(quizId);
            }
        });
        function startQuiz(quizId) {
            currentQuizId = quizId;
            currentQuestions = allQuizzes[quizId].questions;

            userAnswers = {};
            renderQuiz();
            showScreen('quiz');
            const quizDuration = 60 * 10;
            startTimer(quizDuration, document.getElementById('timer'));
        }
        async function submitQuiz() {
            clearInterval(timerInterval);
            let correct = 0, incorrect = 0, unanswered = 0;
            for (let i = 0; i < currentQuestions.length; i++) {
                if (userAnswers[i] && userAnswers[i].answer !== undefined) {
                    if (userAnswers[i].answer === currentQuestions[i].correctAnswer) correct++;
                    else incorrect++;
                } else unanswered++;
            }
            const user = auth.currentUser;
            if (user) {
                try {
                    await addDoc(collection(db, "quizResults"), {
                        userId: user.uid,
                        quizId: currentQuizId,
                        quizTitle: allQuizzes[currentQuizId].title,
                        score: correct,
                        totalQuestions: currentQuestions.length,
                        timestamp: serverTimestamp(),
                        questions: currentQuestions,
                        userAnswers: userAnswers
                    });
                } catch (error) { console.error("Error saving result: ", error); }
            }
            displayResults(correct, incorrect, unanswered);
        }
        function displayResults(correct, incorrect, unanswered) {
            const total = currentQuestions.length;
            const score = total > 0 ? (correct / total) * 100 : 0;
            document.getElementById('score-text').textContent = `${correct}/${total}`;
            document.getElementById('correct-answers').textContent = correct;
            document.getElementById('incorrect-answers').textContent = incorrect;
            document.getElementById('unanswered-questions').textContent = unanswered;
            const progressCircle = document.getElementById('progress-circle');
            const radius = progressCircle.r.baseVal.value;
            const circumference = radius * 2 * Math.PI;
            progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            progressCircle.style.strokeDashoffset = circumference - score / 100 * circumference;
            renderResultDetails(currentQuestions, userAnswers);
            showScreen('result');
        }
        async function loadPastResults(userId) {
            const resultsContainer = document.getElementById('results-list');
            const noResultsText = document.getElementById('no-results-text');
            const deleteBtn = document.getElementById('delete-history-btn');
            resultsContainer.innerHTML = '';
            try {
                const q = query(collection(db, "quizResults"), where("userId", "==", userId));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    noResultsText.style.display = 'block';
                    deleteBtn.classList.add('hidden');
                } else {
                    noResultsText.style.display = 'none';
                    deleteBtn.classList.remove('hidden');
                    const results = [];
                    querySnapshot.forEach((doc) => {
                        results.push({ id: doc.id, ...doc.data() });
                    });
                    results.sort((a, b) => {
                        if (!a.timestamp) return 1;
                        if (!b.timestamp) return -1;
                        return b.timestamp.toMillis() - a.timestamp.toMillis();
                    });
                    results.forEach((data) => {
                        const date = data.timestamp ? data.timestamp.toDate().toLocaleString('vi-VN') : 'N/A';
                        const resultElement = document.createElement('div');
                        resultElement.className = 'flex justify-between items-center p-4 border-b border-gray-200 last:border-b-0';
                        resultElement.innerHTML = `
                            <div>
                                <p class="font-semibold text-gray-800">${data.quizTitle || 'Bài kiểm tra'}</p>
                                <p class="text-sm text-gray-500">Ngày làm: ${date}</p>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="text-right">
                                   <p class="font-bold text-lg text-gray-800">${data.score}/${data.totalQuestions}</p>
                                   <p class="font-semibold text-sm ${data.score/data.totalQuestions >= 0.5 ? 'text-green-600' : 'text-red-600'}">
                                       ${((data.score/data.totalQuestions)*100).toFixed(0)}%
                                   </p>
                                </div>
                                <button data-result-id="${data.id}" class="review-btn bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Xem lại</button>
                            </div>
                        `;
                        resultsContainer.appendChild(resultElement);
                    });
                }
            } catch (error) {
                console.error("Error loading past results: ", error);
                noResultsText.textContent = "Lỗi tải lịch sử. Vui lòng kiểm tra console.";
                noResultsText.style.display = 'block';
            }
        }
        backToHomeBtn.addEventListener('click', async () => {
            if (auth.currentUser) await loadPastResults(auth.currentUser.uid);
            showScreen('main');
        });
        function renderQuiz() {
            const questionsContainer = document.getElementById('questions-container');
            const questionNav = document.getElementById('question-nav');
            questionsContainer.innerHTML = '';
            questionNav.innerHTML = '';
            currentQuestions.forEach((q, index) => {
                const questionElement = document.createElement('div');
                questionElement.id = `question-${index}`;
                questionElement.className = 'mb-8 p-6 border-b border-gray-200 last:border-b-0';
                let optionsHTML = q.options.map((opt, optIndex) => `
                    <label class="flex items-center space-x-3 p-3 rounded-lg cursor-pointer hover:bg-blue-100/50 transition-colors">
                        <input type="radio" name="q_${index}" value="${optIndex}" class="form-radio h-5 w-5 border-gray-300 text-[#2c5282] focus:ring-[#2c5282]">
                        <span class="text-gray-700">${opt}</span>
                    </label>
                `).join('');
                questionElement.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="text-lg font-semibold text-gray-800"><span class="glow-text">Câu ${index + 1}:</span> ${q.question}</h4>
                        <button class="flag-btn p-2 rounded-full hover:bg-yellow-400/20" data-index="${index}">
                            <svg class="w-6 h-6 text-gray-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6H8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/></svg>
                        </button>
                    </div>
                    <div class="space-y-2 mt-4">${optionsHTML}</div>
                `;
                questionsContainer.appendChild(questionElement);
                const navBtn = document.createElement('button');
                navBtn.id = `nav-btn-${index}`;
                navBtn.className = 'w-10 h-10 flex items-center justify-center rounded-lg border-2 border-gray-300 text-gray-500 font-semibold transition-colors';
                navBtn.textContent = index + 1;
                navBtn.addEventListener('click', () => {
                    questionElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
                questionNav.appendChild(navBtn);
            });
            questionsContainer.addEventListener('change', (e) => {
                if (e.target.type === 'radio') {
                    const questionIndex = parseInt(e.target.name.split('_')[1]);
                    if(!userAnswers[questionIndex]) userAnswers[questionIndex] = {};
                    userAnswers[questionIndex].answer = parseInt(e.target.value);
                    updateNavButton(questionIndex);
                }
            });
            questionsContainer.addEventListener('click', (e) => {
                const flagBtn = e.target.closest('.flag-btn');
                if (flagBtn) {
                    const questionIndex = parseInt(flagBtn.dataset.index);
                    if(!userAnswers[questionIndex]) userAnswers[questionIndex] = {};
                    userAnswers[questionIndex].flagged = !userAnswers[questionIndex].flagged;
                    flagBtn.querySelector('svg').classList.toggle('text-yellow-500', userAnswers[questionIndex].flagged);
                    flagBtn.querySelector('svg').classList.toggle('text-gray-400', !userAnswers[questionIndex].flagged);
                    updateNavButton(questionIndex);
                }
            });
        }
        function updateNavButton(index) {
            const navBtn = document.getElementById(`nav-btn-${index}`);
            const state = userAnswers[index];
            navBtn.className = 'w-10 h-10 flex items-center justify-center rounded-lg border-2 font-semibold transition-colors ';
            if (state && state.flagged) navBtn.classList.add('bg-yellow-400', 'border-yellow-500', 'text-black');
            else if (state && state.answer !== undefined) navBtn.classList.add('bg-green-500', 'border-green-600', 'text-white');
            else navBtn.classList.add('bg-white', 'border-gray-300', 'text-gray-500');
        }
        function startTimer(duration, display) {
            let timer = duration;
            timerInterval = setInterval(() => {
                let minutes = parseInt(timer / 60, 10);
                let seconds = parseInt(timer % 60, 10);
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                display.textContent = minutes + ":" + seconds;
                if (--timer < 0) {
                    clearInterval(timerInterval);
                    submitQuiz();
                }
            }, 1000);
        }
        async function renderReview(resultId) {
            try {
                const docRef = doc(db, "quizResults", resultId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const reviewContent = document.getElementById('review-content');
                    const reviewTitle = document.getElementById('review-title');
                    reviewContent.innerHTML = '';
                    reviewTitle.textContent = `Xem Lại: ${data.quizTitle}`;
                    const questions = data.questions || [];
                    const userAnswersData = data.userAnswers || {};
                    questions.forEach((q, index) => {
                        const questionElement = renderResultQuestion(q, index, userAnswersData);
                        reviewContent.appendChild(questionElement);
                    });
                    showScreen('review');
                } else { alert("Không tìm thấy kết quả bài làm."); }
            } catch (error) {
                console.error("Error getting document:", error);
                alert("Đã xảy ra lỗi khi tải chi tiết bài làm.");
            }
        }
        function renderResultDetails(questions, userAnswersData){
            const container = document.getElementById('result-details-container');
            container.innerHTML = '';
            questions.forEach((q, index) => {
                const questionElement = renderResultQuestion(q, index, userAnswersData);
                container.appendChild(questionElement);
            });
        }
        function renderResultQuestion(q, index, userAnswersData) {
            const userAnswerInfo = userAnswersData[index];
            const userAnswerIndex = userAnswerInfo ? userAnswerInfo.answer : undefined;
            let optionsHTML = q.options.map((opt, optIndex) => {
                let optionClasses = "flex items-center space-x-3 p-3 rounded-lg border";
                if (optIndex === q.correctAnswer) {
                    optionClasses += " bg-green-100 border-green-300";
                } else if (optIndex === userAnswerIndex) {
                    optionClasses += " bg-red-100 border-red-300";
                } else {
                    optionClasses += " border-gray-200";
                }
                return `
                    <div class="${optionClasses}">
                        <input type="radio" name="review_q_${index}" value="${optIndex}" class="form-radio h-5 w-5 border-gray-300" ${userAnswerIndex === optIndex ? 'checked' : ''} disabled>
                        <span class="text-gray-800">${opt}</span>
                    </div>
                `;
            }).join('');
            const questionElement = document.createElement('div');
            questionElement.className = 'p-4 border-b border-gray-200 last:border-b-0';
            questionElement.innerHTML = `
                <h4 class="text-lg font-semibold text-gray-800 mb-4"><span class="glow-text">Câu ${index + 1}:</span> ${q.question}</h4>
                <div class="space-y-2 mt-2">${optionsHTML}</div>
            `;
            return questionElement;
        }
        async function deleteAllHistory(userId) {
            if (!confirm('Bạn có chắc chắn muốn xóa toàn bộ lịch sử làm bài không? Hành động này không thể hoàn tác.')) return;
            deleteHistoryBtn.disabled = true;
            deleteHistoryBtn.textContent = 'Đang xóa...';
            try {
                const q = query(collection(db, "quizResults"), where("userId", "==", userId));
                const querySnapshot = await getDocs(q);
                const batch = writeBatch(db);
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                await loadPastResults(userId);
            } catch (error) {
                console.error("Error deleting history: ", error);
                alert('Đã xảy ra lỗi khi xóa lịch sử. Vui lòng kiểm tra lại quy tắc bảo mật (Security Rules) trong Firebase và cấp quyền "delete".');
            } finally {
                deleteHistoryBtn.disabled = false;
                deleteHistoryBtn.textContent = 'Xóa Tất Cả';
            }
        }
        deleteHistoryBtn.addEventListener('click', () => { if (auth.currentUser) deleteAllHistory(auth.currentUser.uid); });
        resultsListContainer.addEventListener('click', (e) => {
            const reviewBtn = e.target.closest('.review-btn');
            if (reviewBtn) {
                const resultId = reviewBtn.dataset.resultId;
                renderReview(resultId);
            }
        });
        backFromReviewBtn.addEventListener('click', () => showScreen('main'));
        submitQuizBtn.addEventListener('click', () => { if (confirm('Bạn có chắc chắn muốn nộp bài không?')) submitQuiz(); });
        loginTabBtn.addEventListener('click', () => {
            loginTabBtn.classList.add('border-[#2c5282]', 'text-[#2c5282]');
            loginTabBtn.classList.remove('border-transparent', 'text-gray-500');
            registerTabBtn.classList.remove('border-[#2c5282]', 'text-[#2c5282]');
            registerTabBtn.classList.add('border-transparent', 'text-gray-500');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            authError.textContent = '';
        });
        registerTabBtn.addEventListener('click', () => {
            registerTabBtn.classList.add('border-[#2c5282]', 'text-[#2c5282]');
            registerTabBtn.classList.remove('border-transparent', 'text-gray-500');
            loginTabBtn.classList.remove('border-[#2c5282]', 'text-[#2c5282]');
            loginTabBtn.classList.add('border-transparent', 'text-gray-500');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            authError.textContent = '';
        });
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try { await createUserWithEmailAndPassword(auth, email, password); } 
            catch (error) { authError.textContent = "Lỗi đăng ký: " + error.code; }
        });
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try { await signInWithEmailAndPassword(auth, email, password); }
            catch (error) { authError.textContent = "Lỗi đăng nhập: " + error.code; }
        });
        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- CHATBOT LOGIC ---
        const chatbotToggleBtn = document.getElementById('chatbot-toggle-btn');
        const chatbotContainer = document.getElementById('chatbot-container');
        const chatbotCloseBtn = document.getElementById('chatbot-close-btn');
        const chatbotForm = document.getElementById('chatbot-form');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatbotSendBtn = document.getElementById('chatbot-send-btn');
        const chatbotMessages = document.getElementById('chatbot-messages');

        let chatHistory = [{ role: "system", content: "You are a helpful assistant." }];

        const toggleChatbot = () => {
            chatbotContainer.classList.toggle('hidden');
            // A small trick to trigger transition
            setTimeout(() => {
                chatbotContainer.classList.toggle('open');
            }, 10);
        };

        chatbotToggleBtn.addEventListener('click', toggleChatbot);
        chatbotCloseBtn.addEventListener('click', toggleChatbot);

        chatbotForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = chatbotInput.value.trim();
            if (message) {
                appendMessage(message, 'user');
                getDeepSeekResponse(message);
                chatbotInput.value = '';
            }
        });

        function appendMessage(message, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', 'mb-2', 'max-w-full');
            
            const messageElement = document.createElement('div');
            messageElement.classList.add('p-3', 'rounded-lg', 'break-words');

            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                messageElement.classList.add('user-message', 'ml-auto');
                messageElement.textContent = message;
            } else { // bot
                messageWrapper.classList.add('justify-start');
                messageElement.classList.add('bot-message', 'mr-auto');
                if (message === 'typing...') {
                    messageElement.innerHTML = `<div class="flex items-center justify-center space-x-1"><div class="h-2 w-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.3s]"></div><div class="h-2 w-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.15s]"></div><div class="h-2 w-2 bg-gray-400 rounded-full animate-bounce"></div></div>`;
                    messageElement.id = 'typing-indicator';
                } else {
                    messageElement.textContent = message;
                }
            }
            
            messageWrapper.appendChild(messageElement);
            chatbotMessages.appendChild(messageWrapper);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }

        async function getDeepSeekResponse(userMessage) {
            // --- CẤU HÌNH CHATBOT DEEPSEEK ---
            // QUAN TRỌNG: Thay thế "YOUR_DEEPSEEK_API_KEY" bằng API Key của bạn
            const DEEPSEEK_API_KEY = "YOUR_DEEPSEEK_API_KEY";
            const API_URL = "https://api.deepseek.com/chat/completions";
            
            if (DEEPSEEK_API_KEY === "YOUR_DEEPSEEK_API_KEY") {
                appendMessage("Lỗi: Vui lòng cấu hình API Key của DeepSeek trong mã nguồn.", 'bot');
                return;
            }

            chatbotSendBtn.disabled = true;
            appendMessage('typing...', 'bot');
            
            chatHistory.push({ role: "user", content: userMessage });

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: chatHistory
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const botMessage = data.choices[0].message.content;

                chatHistory.push({ role: "assistant", content: botMessage });
                
                // Remove typing indicator and add bot response
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) typingIndicator.parentElement.remove();
                appendMessage(botMessage, 'bot');

            } catch (error) {
                console.error("Error calling DeepSeek API:", error);
                 const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) typingIndicator.parentElement.remove();
                appendMessage("Rất tiếc, đã có lỗi xảy ra. Vui lòng thử lại.", 'bot');
            } finally {
                chatbotSendBtn.disabled = false;
            }
        }

    </script>
</body>
</html>

